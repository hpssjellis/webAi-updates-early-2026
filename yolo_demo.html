<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Node Lab: Vision AI v4</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: #eee; text-align: center; padding: 20px; }
        .myViewport { position: relative; display: inline-block; border: 2px solid #333; margin: 20px; background: #000; }
        #myImage { max-width: 100%; height: auto; display: block; }
        #myCanvas { position: absolute; top: 0; left: 0; pointer-events: none; width: 100%; height: 100%; }
        .myBtn { background: #0d6efd; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 1rem; }
        .myBtn:disabled { background: #444; cursor: wait; }
        #myStatus { color: #4ec9b0; margin: 10px; font-family: monospace; }
    </style>
</head>
<body>

    <h2>üëÅÔ∏è YOLOv8 Object Detection</h2>
    
    <div class="myViewport">
        <img id="myImage" src="https://huggingface.co/datasets/Xenova/transformers.js-docs/resolve/main/cats.jpg" crossorigin="anonymous">
        <canvas id="myCanvas"></canvas>
    </div>

    <div>
        <div id="myStatus">Initializing Engine...</div>
        <button class="myBtn" id="myRunButton" onclick="myStartDetection()" disabled>Please Wait...</button>
    </div>

    <script type="module">
        // Using your specific v4.0.0 CDN link
        import { pipeline, env } from "https://cdn.jsdelivr.net/npm/@huggingface/transformers@4.0.0-next.3";
                                         

        async function myStartDetection() {
            const myStatus = document.getElementById('myStatus');
            const myButton = document.getElementById('myRunButton');
            const myImage = document.getElementById('myImage');
            const myCanvas = document.getElementById('myCanvas');
            const myCtx = myCanvas.getContext('2d');

            myButton.disabled = true;
            myStatus.innerText = "üåÄ Running AI Analysis...";

            try {
                // THE CRITICAL FIX FOR "UNAUTHORIZED":
                // Bypass HEAD requests and go straight to Hugging Face
                env.allowLocalModels = false;
                env.remoteHost = "https://huggingface.co/";
                env.remotePathTemplate = "{model}/resolve/{revision}/";

                const myDetector = await pipeline("object-detection", "Xenova/yolov8n");
                const myResults = await myDetector(myImage);

                // Draw results
                myCanvas.width = myImage.naturalWidth;
                myCanvas.height = myImage.naturalHeight;
                myCtx.clearRect(0, 0, myCanvas.width, myCanvas.height);

                myResults.forEach(myRes => {
                    const { xmin, ymin, xmax, ymax } = myRes.box;
                    myCtx.strokeStyle = "#00ff00";
                    myCtx.lineWidth = 5;
                    myCtx.strokeRect(xmin, ymin, xmax - xmin, ymax - ymin);
                    
                    myCtx.fillStyle = "#00ff00";
                    myCtx.font = "bold 20px Arial";
                    myCtx.fillText(myRes.label, xmin, ymin - 10);
                });

                myStatus.innerText = `‚úÖ Found ${myResults.length} objects.`;
            } catch (myErr) {
                myStatus.innerText = "‚ùå Error: " + myErr.message;
                console.error(myErr);
            } finally {
                myButton.disabled = false;
            }
        }

        // KEY FIX: Explicitly attach to window so the HTML 'onclick' can see it
        window.myStartDetection = myStartDetection;

        // ONLY enable the button once the module has finished loading everything
        document.getElementById('myRunButton').disabled = false;
        document.getElementById('myRunButton').innerText = "Start AI Analysis";
        document.getElementById('myStatus').innerText = "Engine Ready.";
    </script>
</body>
</html>
