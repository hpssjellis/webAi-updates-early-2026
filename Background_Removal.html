<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Background Remover</title>
    <style>
        body { background: #111; color: #fff; font-family: sans-serif; padding: 20px; text-align: center; }
        video, canvas { width: 320px; height: 240px; border: 1px solid #444; border-radius: 6px; display: block; margin: 10px auto; }
        canvas { background-image: repeating-conic-gradient(#222 0% 25%, #333 0% 50%); background-size: 20px 20px; }
        button { margin: 5px; padding: 10px 22px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        #myStatus { margin-top: 10px; font-size: 0.8rem; color: #888; font-family: monospace; }
    </style>
</head>
<body>
    <h2>‚úÇÔ∏è Background Remover</h2>

    <video id="myCam" autoplay playsinline muted style="transform: scaleX(-1);"></video>
    <canvas id="myOutputCanvas" width="320" height="240"></canvas>

    <div>
        <button id="myLoadBtn" style="background: #ff0077; color: #fff;">‚ö° Load Model</button>
        <button id="mySnapBtn" style="background: #00ffcc; color: #000;" disabled>üì∏ Snap & Remove BG</button>
    </div>
    <div id="myStatus">Click Load Model to begin.</div>

    <script type="module">
        import { pipeline, env } from "https://cdn.jsdelivr.net/npm/@huggingface/transformers@4.0.0-next.4";
        env.allowLocalModels = false;

        let myPipe = null;
        const myCam     = document.getElementById("myCam");
        const myCanvas  = document.getElementById("myOutputCanvas");
        const myStatus  = document.getElementById("myStatus");
        const myLoadBtn = document.getElementById("myLoadBtn");
        const mySnapBtn = document.getElementById("mySnapBtn");

        navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 } })
            .then(stream => { myCam.srcObject = stream; })
            .catch(() => { myStatus.innerText = "‚ùå Camera access denied."; });

        myLoadBtn.onclick = async () => {
            myLoadBtn.disabled = true;
            // NOTE: BEN2-ONNX has a confirmed open bug on WebGPU (issue #1272) where
            // the mask output is corrupted, causing toCanvas() to fail with
            // "Cannot read properties of undefined". WASM produces correct results.
            myStatus.innerText = "‚è≥ Loading model (WASM)...";
            console.log("[BG Remover] Loading model...");
            try {
                myPipe = await pipeline("background-removal", "onnx-community/BEN2-ONNX", {
                    device: "wasm",
                    progress_callback: (p) => {
                        if (p.status === 'initiate') {
                            const msg = `Fetching: ${p.file}`;
                            myStatus.innerText = msg;
                            console.log(`[BG Remover] ${msg}`);
                        } else if (p.status === 'progress' && p.total) {
                            const pct = Math.round(p.progress);
                            const mb  = (p.loaded / 1024 / 1024).toFixed(1);
                            const tot = (p.total  / 1024 / 1024).toFixed(1);
                            const msg = `‚Üì ${p.file}  ${mb} / ${tot} MB  (${pct}%)`;
                            myStatus.innerText = msg;
                            console.log(`[BG Remover] ${msg}`);
                        } else if (p.status === 'done') {
                            const msg = `‚úî Loaded: ${p.file}`;
                            myStatus.innerText = msg;
                            console.log(`[BG Remover] ${msg}`);
                        } else if (p.status === 'ready') {
                            const msg = 'üü¢ Model ready!';
                            myStatus.innerText = msg;
                            console.log(`[BG Remover] ${msg}`);
                        }
                    },
                });
                myStatus.innerText = "üü¢ Ready ‚Äî press Snap!";
                mySnapBtn.disabled = false;
                myLoadBtn.style.display = "none";
            } catch (e) {
                myStatus.innerText = "‚ùå " + e.message;
                console.error("[BG Remover] Load failed:", e);
                myLoadBtn.disabled = false;
            }
        };

        mySnapBtn.onclick = async () => {
            mySnapBtn.disabled = true;
            myStatus.innerText = "‚è≥ Processing...";
            console.log("[BG Remover] Running inference...");

            const mySnap = document.createElement("canvas");
            mySnap.width  = myCam.videoWidth  || 320;
            mySnap.height = myCam.videoHeight || 240;
            const mySnapCtx = mySnap.getContext("2d");
            mySnapCtx.translate(mySnap.width, 0);
            mySnapCtx.scale(-1, 1);
            mySnapCtx.drawImage(myCam, 0, 0);

            try {
                const myOutput = await myPipe(mySnap);
                console.log("[BG Remover] Output:", myOutput);
                await myOutput[0].toCanvas(myCanvas);
                myStatus.innerText = "‚úÖ Done!";
            } catch (e) {
                myStatus.innerText = "‚ùå " + e.message;
                console.error("[BG Remover] Inference failed:", e);
            } finally {
                mySnapBtn.disabled = false;
            }
        };
    </script>
</body>
</html>
