<body style="font-family: sans-serif; padding: 20px; text-align: center; background: #111; color: white;">
    <h1>Real-Time Object Detection</h1>
    <video id="myVideo" autoplay playsinline style="width: 100%; max-width: 500px; border: 2px solid #555;"></video>
    <div id="myResult" style="font-size: 1.5rem; margin-top: 20px; color: #0f0;">Starting camera...</div>

    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@4.0.0-next.4';

        let myDetector;
        const myVideoElement = document.getElementById('myVideo');
        const myResultElement = document.getElementById('myResult');

        async function mySetupCamera() {
            const myStream = await navigator.mediaDevices.getUserMedia({ video: true });
            myVideoElement.srcObject = myStream;
            // Wait for video to actually start playing
            return new Promise(resolve => myVideoElement.onloadedmetadata = () => {
                myVideoElement.play();
                resolve();
            });
        }

        async function myContinuousDetection() {
            if (myDetector) {
                try {
                    // FIX: Pass the video ELEMENT, not the srcObject stream
                    const myOutput = await myDetector(myVideoElement);
                    
                    if (myOutput.length > 0) {
                        // DETR returns an array of objects. We take the highest score.
                        const myTopMatch = myOutput.reduce((prev, current) => (prev.score > current.score) ? prev : current);
                        myResultElement.innerText = `${myTopMatch.label} (${(myTopMatch.score * 100).toFixed(1)}%)`;
                    } else {
                        myResultElement.innerText = "No objects detected";
                    }
                } catch (myError) {
                    console.error("Detection error:", myError);
                }
            }
            // Loop the detection
            requestAnimationFrame(myContinuousDetection);
        }

        async function myInit() {
            try {
                await mySetupCamera();
                myResultElement.innerText = "Loading Model (WebGPU)...";
                
                // Initializing the pipeline
                myDetector = await pipeline('object-detection', 'Xenova/detr-resnet-50', { 
                    device: 'webgpu', 
                    dtype: 'q8' 
                });
                
                myResultElement.innerText = "Model Ready!";
                myContinuousDetection();
            } catch (myErr) {
                myResultElement.innerText = "Error: " + myErr.message;
            }
        }

        // Static link to start the program
        window.onload = myInit;
    </script>
</body>
