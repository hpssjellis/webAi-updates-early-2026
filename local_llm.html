<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Local LLM Chat â€” Transformers.js v4</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: #0d0d0d;
            color: #eee;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }

        h2 {
            color: #00ffcc;
            font-size: 1.5rem;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        /* â”€â”€ Chat Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #chatContainer {
            width: 100%;
            max-width: 700px;
            height: 60vh;
            background: #151515;
            border: 1px solid #333;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #chatHistory {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scrollbar-width: thin;
            scrollbar-color: #333 #151515;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .user-msg {
            align-self: flex-end;
            background: #00ffcc;
            color: #000;
            border-bottom-right-radius: 2px;
        }

        .ai-msg {
            align-self: flex-start;
            background: #222;
            color: #eee;
            border-bottom-left-radius: 2px;
            border: 1px solid #333;
        }

        /* â”€â”€ Input Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #inputArea {
            padding: 15px;
            background: #1a1a1a;
            border-top: 1px solid #333;
            display: flex;
            gap: 10px;
        }

        #userInput {
            flex: 1;
            background: #0d0d0d;
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            outline: none;
        }

        #userInput:focus { border-color: #00ffcc; }

        /* â”€â”€ Controls & Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #myControls {
            margin-top: 20px;
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            background: #00ffcc;
            color: #000;
            border: none;
            border-radius: 5px;
            transition: 0.2s;
        }

        button:disabled { opacity: 0.4; cursor: not-allowed; }

        select {
            background: #1e1e1e;
            color: #eee;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 4px;
        }

        #myStatus {
            margin-top: 15px;
            font-family: monospace;
            font-size: 0.85rem;
            color: #888;
            text-align: center;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.75rem;
            margin-left: 5px;
        }
        .webgpu { background: #0d2e20; color: #00ffcc; }
        .wasm { background: #2a2a10; color: #ffcc00; }
    </style>
</head>
<body>

    <h2>âš¡ Local LLM Chat â€” Transformers.js v4</h2>

    <div id="chatContainer">
        <div id="chatHistory">
            <div class="message ai-msg">Hello! Select a model and click "Initialize" to start chatting locally in your browser.</div>
        </div>
        <div id="inputArea">
            <input type="text" id="userInput" placeholder="Type a message..." disabled>
            <button id="sendBtn" onclick="window.sendMessage()" disabled>Send</button>
        </div>
    </div>

    <div id="myControls">
        <select id="modelSel">
            <option value="onnx-community/DeepSeek-R1-Distill-Qwen-1.5B-ONNX">DeepSeek-R1-1.5B (~1.2GB - Heavy)</option>
            <option value="HuggingFaceTB/SmolLM2-135M-Instruct">SmolLM2-135M (~270MB - Fast)</option>
            <option value="onnx-community/Qwen2.5-0.5B-Instruct">Qwen2.5-0.5B (~950MB - Balanced)</option>
        </select>
        <button id="initBtn" onclick="window.initModel()">ğŸš€ Initialize Model</button>
        <div id="deviceInfo"></div>
    </div>

    <div id="myStatus">Ready. Please note: First load will download several hundred MBs to your browser cache.</div>

    <script type="module">
        import { pipeline, env } from "https://cdn.jsdelivr.net/npm/@huggingface/transformers@4.0.0-next.4";

        // Configuration
        env.allowLocalModels = false;
        env.useBrowserCache = true;

        let generator = null;
        let messages = [];

        const statusEl = document.getElementById('myStatus');
        const historyEl = document.getElementById('chatHistory');
        const inputEl = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const initBtn = document.getElementById('initBtn');
        const modelSel = document.getElementById('modelSel');

        // Helper: Append messages to UI
        function appendMessage(role, text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role === 'user' ? 'user-msg' : 'ai-msg'}`;
            msgDiv.textContent = text;
            historyEl.appendChild(msgDiv);
            historyEl.scrollTop = historyEl.scrollHeight;
            return msgDiv;
        }

        // â”€â”€ Initialize Model â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.initModel = async () => {
            const modelId = modelSel.value;
            initBtn.disabled = true;
            modelSel.disabled = true;
            
            let device = "wasm";
            if (navigator.gpu) {
                try {
                    const adapter = await navigator.gpu.requestAdapter();
                    if (adapter) device = "webgpu";
                } catch (e) { console.warn("WebGPU not available"); }
            }

            statusEl.textContent = `â¬‡ï¸ Loading ${modelId} on ${device.toUpperCase()}...`;

            try {
                generator = await pipeline("text-generation", modelId, {
                    device: device,
                    progress_callback: p => {
                        if (p.status === "progress") {
                            statusEl.textContent = `â¬‡ï¸ Downloading: ${Math.round(p.loaded / 1024 / 1024)}MB / ${Math.round(p.total / 1024 / 1024)}MB`;
                        }
                    }
                });

                document.getElementById('deviceInfo').innerHTML = `<span class="badge ${device}">${device.toUpperCase()} ACTIVE</span>`;
                statusEl.textContent = "ğŸŸ¢ Model Ready!";
                inputEl.disabled = false;
                sendBtn.disabled = false;
                initBtn.style.display = 'none';
            } catch (err) {
                statusEl.textContent = "âŒ Error: " + err.message;
                initBtn.disabled = false;
                console.error(err);
            }
        };

        // â”€â”€ Handle Sending â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.sendMessage = async () => {
            const text = inputEl.value.trim();
            if (!text || !generator) return;

            // Update UI
            inputEl.value = "";
            appendMessage('user', text);
            messages.push({ role: "user", content: text });

            // Prepare AI response container
            const aiMsgDiv = appendMessage('assistant', "...");
            inputEl.disabled = true;
            sendBtn.disabled = true;

            try {
                // Run inference
                const output = await generator(messages, { 
                    max_new_tokens: 256,
                    temperature: 0.7,
                    do_sample: true,
                    top_k: 40
                });

                const response = output[0].generated_text.at(-1).content;
                aiMsgDiv.textContent = response;
                messages.push({ role: "assistant", content: response });

            } catch (err) {
                aiMsgDiv.textContent = "âŒ Error during generation: " + err.message;
            } finally {
                inputEl.disabled = false;
                sendBtn.disabled = false;
                inputEl.focus();
            }
        };

        // Enter key support
        inputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') window.sendMessage();
        });

    </script>
</body>
</html>
