<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Janus-Pro | Image Generator</title>
    <style>
        :root { --accent: #00ffcc; --bg: #0d0d0d; --panel: #161616; }
        body { background: var(--bg); color: #eee; font-family: system-ui; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: var(--panel); border: 1px solid #333; border-radius: 12px; padding: 20px; width: 100%; max-width: 600px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        button { background: var(--accent); color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        button:disabled { opacity: 0.3; }
        input { flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 6px; }
        #resultImage { width: 100%; border-radius: 8px; margin-top: 15px; display: none; image-rendering: pixelated; }
        .status { font-family: monospace; font-size: 0.8rem; color: #888; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>
    <h2>ðŸŽ¨ Janus-Pro Image Gen</h2>
    <div class="card">
        <button id="initBtn">ðŸš€ Load Model (1.2GB)</button>
        <div id="uiBody" style="display: none; margin-top: 20px;">
            <div class="controls">
                <input type="text" id="promptInput" placeholder="A futuristic cyberpunk city...">
                <button id="genBtn">Generate</button>
            </div>
            <img id="resultImage" alt="Generated result">
        </div>
        <div id="statusMsg" class="status">WebGPU required for best performance.</div>
    </div>

   <script type="module">
    import { AutoProcessor, MultiModalityCausalLM, RawImage } from "https://cdn.jsdelivr.net/npm/@huggingface/transformers@4.0.0-next.4";
    let model, processor;
    const statusMsg = document.getElementById('statusMsg');

    document.getElementById('initBtn').onclick = async (e) => {
        e.target.disabled = true;
        statusMsg.textContent = "Loading weights...";
        const model_id = "onnx-community/Janus-Pro-1B-ONNX";

        processor = await AutoProcessor.from_pretrained(model_id);
        model = await MultiModalityCausalLM.from_pretrained(model_id, {
            device: 'webgpu',
            dtype: 'q4',
        });

        document.getElementById('uiBody').style.display = 'block';
        e.target.style.display = 'none';
        statusMsg.textContent = "Vision Ready.";
    };

    document.getElementById('analyzeBtn').onclick = async () => {
        const file = document.getElementById('fileInput').files[0];
        const query = document.getElementById('queryInput').value || "Describe this image.";
        if (!file) return alert("Select an image first!");
        statusMsg.textContent = "Processing image...";

        try {
            const image = await RawImage.fromURL(URL.createObjectURL(file));

            const conversation = [
                { role: 'user', content: '<image_placeholder>\n' + query }
            ];

            // Apply chat template to get the prompt string
            const inputs = await processor(conversation, {
                images: [image],
                chat_template: 'text_generation',
            });

            const outputs = await model.generate({
                ...inputs,
                max_new_tokens: 128,
            });

            // outputs is a Tensor â€” convert to a nested JS array before batch_decode
            const outputArray = outputs.tolist();  // converts Tensor â†’ number[][]

            const decoded = processor.batch_decode(outputArray, {
                skip_special_tokens: true,
            });

            document.getElementById('resultText').textContent =
                decoded[0].split('assistant\n').pop().trim();

            statusMsg.textContent = "Complete.";
        } catch (err) {
            console.error(err);
            statusMsg.textContent = "Error: " + err.message;
        }
    };
</script></body>
</html>
