<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Janus-Pro | Text-to-Image</title>
    <style>
        body { background: #080808; color: #e8e8e8; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .myCard { background: #101010; border: 1px solid #222; border-radius: 12px; padding: 25px; width: 100%; max-width: 600px; }
        #myOutputCanvas { width: 100%; border-radius: 8px; margin-top: 15px; display: none; background: #000; border: 1px solid #333; }
        .myBtn { width: 100%; padding: 12px; margin-top: 10px; cursor: pointer; border-radius: 6px; font-weight: bold; transition: opacity 0.2s; }
        .myBtn:disabled { opacity: 0.5; cursor: not-allowed; }
        #myStatus { font-size: 0.8rem; color: #888; margin-top: 10px; font-family: monospace; text-align: center; }
        textarea { border-radius: 6px; resize: none; }
    </style>
</head>
<body>

<div class="myCard">
    <h2 style="color: #00ffcc; margin-top: 0;">‚ú¶ Janus-Pro Local Gen</h2>

    <div id="myLoadSection">
        <p style="font-size: 0.8rem; color: #666;">Downloads ~800MB‚Äì1.2GB. WebGPU required.</p>
        <button class="myBtn" id="myLoadBtn" onclick="window.myInitModel()"
            style="background: transparent; border: 1px solid #00ffcc; color: #00ffcc;">‚ö° Load Model</button>
    </div>

    <div id="myGenSection" style="display: none;">
        <textarea id="myPromptInput"
            style="width: 100%; height: 80px; background: #000; color: #fff; border: 1px solid #333; padding: 10px; box-sizing: border-box;"
            placeholder="A beautiful oil painting of a futuristic city..."></textarea>

        <button class="myBtn" id="myGenBtn" onclick="window.myGenerateImage()"
            style="background: #00ffcc; border: none; color: #000;">‚ú¶ Generate Image</button>

        <div id="myTokenProgress" style="height: 6px; background: #222; margin-top: 15px; display: none; border-radius: 3px; overflow: hidden;">
            <div id="myTokenBar" style="height: 100%; background: #00ffcc; width: 0%; transition: width 0.1s;"></div>
        </div>
    </div>

    <canvas id="myOutputCanvas"></canvas>
    <div id="myStatus">Ready to load.</div>
</div>

<script type="module">
import { AutoProcessor, MultiModalityCausalLM, env }
    from "https://cdn.jsdelivr.net/npm/@huggingface/transformers@4.0.0-next.4";

env.allowLocalModels = false;

let myModel = null;
let myProcessor = null;
const myStatus = document.getElementById('myStatus');
const myCanvas = document.getElementById('myOutputCanvas');

window.myInitModel = async function() {
    const myBtn = document.getElementById('myLoadBtn');
    myBtn.disabled = true;

    try {
        const myModelId = "onnx-community/Janus-Pro-1B-ONNX";

        myStatus.innerText = "‚è≥ Loading processor...";
        myProcessor = await AutoProcessor.from_pretrained(myModelId);

        myStatus.innerText = "‚è≥ Loading model submodels (this may take a while)...";

        myModel = await MultiModalityCausalLM.from_pretrained(myModelId, {
            device: {
                prepare_inputs_embeds: "wasm",   // Known WebGPU bug ‚Äî keep on wasm
                language_model:        "webgpu",
                lm_head:               "webgpu",
                gen_head:              "webgpu",
                gen_img_embeds:        "webgpu",
                image_decode:          "wasm",   // FIX: Large model, fp32 OOMs WebGPU
            },
            dtype: {
                prepare_inputs_embeds: "fp32",
                language_model:        "q4f16",  // FIX: More driver-compatible than q4
                lm_head:               "fp16",
                gen_head:              "fp16",
                gen_img_embeds:        "fp16",
                image_decode:          "fp32",
            },
            // FIX: Progress callback lets you see exactly which file causes the crash
            progress_callback: (p) => {
                if (p.status === 'initiate') {
                    myStatus.innerText = `‚è≥ Fetching: ${p.file}`;
                } else if (p.status === 'progress') {
                    const pct = Math.round(p.progress ?? 0);
                    myStatus.innerText = `‚¨áÔ∏è ${p.file} ‚Äî ${pct}%`;
                } else if (p.status === 'done') {
                    myStatus.innerText = `‚úÖ Loaded: ${p.file}`;
                }
            }
        });

        myStatus.innerText = "üü¢ Model Ready!";
        document.getElementById('myLoadSection').style.display = 'none';
        document.getElementById('myGenSection').style.display = 'block';

    } catch (myErr) {
        console.error(myErr);
        myStatus.innerText = "‚ùå Load Error: " + myErr.message;
        myBtn.disabled = false;
    }
};

window.myGenerateImage = async function() {
    const myPrompt = document.getElementById('myPromptInput').value.trim();
    const myGenBtn = document.getElementById('myGenBtn');
    const myBar    = document.getElementById('myTokenBar');
    const myWrap   = document.getElementById('myTokenProgress');

    if (!myPrompt) return alert("Please enter a prompt");

    myGenBtn.disabled = true;
    myCanvas.style.display = 'none';
    myWrap.style.display = 'block';
    myBar.style.width = "0%";

    try {
        const myMessages = [{ role: "User", content: myPrompt }];
        const myInputs   = await myProcessor(myMessages, { chat_template: "text_to_image" });
        const myNumTokens = myProcessor.num_image_tokens;

        myStatus.innerText = `üé® Generating ${myNumTokens} tokens...`;

        const myOutputs = await myModel.generate_images({
            ...myInputs,
            min_new_tokens: myNumTokens,
            max_new_tokens: myNumTokens,
            do_sample: true,
            temperature: 1.0,
            callback_function: (output_ids) => {
                const promptLen    = myInputs.input_ids.dims.at(-1);
                const currentTokens = output_ids[0].length - promptLen;
                const myPct = Math.min((currentTokens / myNumTokens) * 100, 100);
                myBar.style.width = myPct + "%";
            }
        });

        myStatus.innerText = "‚ú® Rendering image...";
        await myOutputs[0].toCanvas(myCanvas);
        myCanvas.style.display = 'block';
        myStatus.innerText = "‚úÖ Done!";

    } catch (myErr) {
        console.error(myErr);
        myStatus.innerText = "‚ùå Gen Error: " + myErr.message;
    } finally {
        myGenBtn.disabled = false;
        myWrap.style.display = 'none';
    }
};
</script>
</body>
</html>
