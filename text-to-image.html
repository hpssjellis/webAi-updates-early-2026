<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Janus-Pro | Text-to-Image</title>
    <style>
        /* Keeping your custom styling but ensuring it's minimal as per your preference */
        body { background: #080808; color: #e8e8e8; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .myCard { background: #101010; border: 1px solid #222; border-radius: 12px; padding: 25px; width: 100%; max-width: 600px; }
        #myOutputCanvas { width: 100%; border-radius: 8px; margin-top: 15px; display: none; background: #000; }
        .myBtn { width: 100%; padding: 12px; margin-top: 10px; cursor: pointer; border-radius: 6px; font-weight: bold; }
        #myStatus { font-size: 0.8rem; color: #888; margin-top: 10px; font-family: monospace; }
    </style>
</head>
<body>

    <div class="myCard">
        <h2 style="color: #00ffcc; margin-top: 0;">‚ú¶ Janus-Pro Local Gen</h2>
        
        <div id="myLoadSection">
            <p style="font-size: 0.8rem; color: #666;">Note: Downloads ~800MB. Requires WebGPU.</p>
            <button class="myBtn" id="myLoadBtn" onclick="window.myInitModel()" style="background: transparent; border: 1px solid #00ffcc; color: #00ffcc;">‚ö° Load Model</button>
        </div>

        <div id="myGenSection" style="display: none;">
            <textarea id="myPromptInput" style="width: 100%; height: 80px; background: #000; color: #fff; border: 1px solid #333; padding: 10px; box-sizing: border-box;" placeholder="A cyberpunk cat in a neon city..."></textarea>
            
            <button class="myBtn" id="myGenBtn" onclick="window.myGenerateImage()" style="background: #00ffcc; border: none; color: #000;">‚ú¶ Generate Image</button>
            
            <div id="myTokenProgress" style="height: 4px; background: #222; margin-top: 10px; display: none;">
                <div id="myTokenBar" style="height: 100%; background: #00ffcc; width: 0%;"></div>
            </div>
        </div>

        <canvas id="myOutputCanvas"></canvas>
        <div id="myStatus">Waiting for user...</div>
    </div>

    <script type="module">
        import { AutoProcessor, MultiModalityCausalLM, RawImage } from "https://cdn.jsdelivr.net/npm/@huggingface/transformers@4.0.0-next.4";

        let myModel = null;
        let myProcessor = null;
        const myStatus = document.getElementById('myStatus');
        const myCanvas = document.getElementById('myOutputCanvas');

        // 1. Initialize Model
        window.myInitModel = async function() {
            const myBtn = document.getElementById('myLoadBtn');
            myBtn.disabled = true;
            myStatus.innerText = "‚è≥ Initializing WebGPU & Downloading...";

            try {
                const myModelId = "onnx-community/Janus-Pro-1B-ONNX";

                myProcessor = await AutoProcessor.from_pretrained(myModelId);
                
                myModel = await MultiModalityCausalLM.from_pretrained(myModelId, {
                    device: 'webgpu',
                    dtype: {
                        prepare_inputs_embeds: 'q4',
                        language_model: 'q4',
                        lm_head: 'fp16',
                        gen_head: 'fp16',
                        gen_img_embeds: 'fp16',
                        image_decode: 'fp32',
                    }
                });

                myStatus.innerText = "üü¢ Model Ready!";
                document.getElementById('myLoadSection').style.display = 'none';
                document.getElementById('myGenSection').style.display = 'block';
            } catch (myErr) {
                myStatus.innerText = "‚ùå Load Error: " + myErr.message;
                myBtn.disabled = false;
            }
        };

        // 2. Generate Image
        window.myGenerateImage = async function() {
            const myPrompt = document.getElementById('myPromptInput').value;
            const myGenBtn = document.getElementById('myGenBtn');
            const myBar = document.getElementById('myTokenBar');
            const myWrap = document.getElementById('myTokenProgress');

            if (!myPrompt) return alert("Please enter a prompt");

            myGenBtn.disabled = true;
            myStatus.innerText = "üé® Generating tokens (576 required)...";
            myWrap.style.display = 'block';

            try {
                // Correct template role for Janus
                const myMessages = [{ role: 'user', content: myPrompt }];
                
                // Use the specific text_to_image template
                const myInputs = await myProcessor(myMessages, { chat_template: 'text_to_image' });
                
                const myNumTokens = myProcessor.num_image_tokens; // Usually 576

                const myOutput = await myModel.generate({
                    ...myInputs,
                    max_new_tokens: myNumTokens,
                    do_sample: true,
                    temperature: 1.0,
                    callback_function: (myTokens) => {
                        const myCount = myTokens[0].output_ids.length - myInputs.input_ids.dims.at(-1);
                        const myPct = (myCount / myNumTokens) * 100;
                        myBar.style.width = myPct + "%";
                    }
                });

                myStatus.innerText = "‚ú® Decoding pixels...";

                // Slice tokens: remove the prompt tokens, keep the new image tokens
                const myPromptLen = myInputs.input_ids.dims.at(-1);
                const myImageTokens = myOutput.slice(null, [myPromptLen, null]);

                // Convert tokens back to an image
                const myDecoded = await myProcessor.decode_image(myImageTokens);

                // Draw to Canvas
                myCanvas.width = myDecoded.width;
                myCanvas.height = myDecoded.height;
                myCanvas.style.display = 'block';
                const myCtx = myCanvas.getContext('2d');
                const myData = new ImageData(myDecoded.data, myDecoded.width, myDecoded.height);
                myCtx.putImageData(myData, 0, 0);

                myStatus.innerText = "‚úÖ Generation Complete!";
            } catch (myErr) {
                console.error(myErr);
                myStatus.innerText = "‚ùå Gen Error: " + myErr.message;
            } finally {
                myGenBtn.disabled = false;
                myWrap.style.display = 'none';
            }
        };
    </script>
</body>
</html>
